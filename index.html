<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Viewer Pro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        body { background-color: #2D2D2D; margin: 0; font-family: sans-serif; }
        header { 
            background: #24292e; color: white; padding: 10px 20px; 
            display: flex; gap: 10px; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        #fileName { color: #ffffff; font-weight: bold; margin-left: auto; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .container { max-width: 900px; margin: 30px auto; background: black; padding: 45px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .markdown-body { background-color: black !important; color: #e6edf3 !important; }

        button, input[type="file"], #searchInput { padding: 8px 12px; border-radius: 5px; border: none; font-weight: bold; }
        button { background: #2ea44f; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        button:hover { background: #2c974b; }
        #fileInput { background: #0366d6; color: white; cursor: pointer; }
        #driveBtn { background: #f4b400; color: #111; padding: 8px 10px; font-size: 16px; }
        #driveBtn:hover { background: #e2a700; }
        
        /* Estilo Pesquisa e Setas */
        .search-container { display: flex; gap: 5px; align-items: center; background: #3f4448; border-radius: 5px; padding-right: 5px; }
        #searchInput { background: transparent; color: white; width: 180px; font-weight: normal; outline: none; }
        .nav-btn { background: #57606a; padding: 5px 8px; font-size: 12px; min-width: 30px; }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        #searchCount { font-size: 11px; color: #8b949e; min-width: 40px; text-align: center; }

        mark.search-highlight { background-color: #ffdf5d !important; color: black !important; border-radius: 2px; }
        mark.current-highlight { background-color: #f39c12 !important; outline: 2px solid white; }

        .code-wrapper { position: relative; }
        .copy-btn { position: absolute; right: 10px; top: 10px; padding: 4px 8px; font-size: 12px; background: #444; color: white; border: 1px solid #666; border-radius: 4px; opacity: 0.7; z-index: 10; }
        #scrollTopBtn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 46px;
            height: 46px;
            border-radius: 999px;
            background: #2ea44f;
            border: none;
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
            z-index: 200;
        }
        #scrollTopBtn:hover { background: #2c974b; }
        #scrollTopBtn svg { width: 22px; height: 22px; fill: currentColor; }
        .drive-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 340px;
            max-height: 70vh;
            overflow-y: auto;
            background: #20252b;
            border: 1px solid #3f4448;
            border-radius: 8px;
            padding: 12px;
            z-index: 250;
            box-shadow: 0 10px 24px rgba(0,0,0,0.45);
            color: #e6edf3;
        }
        .drive-panel.hidden { display: none; }
        .drive-panel h3 { margin: 0 0 8px; font-size: 14px; color: #fff; }
        .drive-note { font-size: 11px; color: #8b949e; line-height: 1.35; margin: 0 0 9px; }
        .drive-actions { display: flex; gap: 7px; margin-bottom: 10px; }
        .drive-actions button { flex: 1; padding: 7px 8px; font-size: 12px; }
        .drive-files { display: flex; flex-direction: column; gap: 6px; }
        .drive-file {
            width: 100%;
            border: 1px solid #3f4448;
            background: #2b3138;
            color: #e6edf3;
            border-radius: 6px;
            padding: 7px 9px;
            font-size: 12px;
            text-align: left;
        }
        .drive-file:hover { background: #333a43; }
        .drive-empty { font-size: 12px; color: #8b949e; }

        @media print { header { display: none; } .container { box-shadow: none; margin: 0; width: 100%; max-width: none; } }
    </style>
</head>
<body>

<header>
    <input type="file" id="fileInput" accept=".md">
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="üîç Pesquisar...">
        <span id="searchCount">0/0</span>
        <button class="nav-btn" onclick="navigateSearch(-1)" title="Anterior">‚ñ≤</button>
        <button class="nav-btn" onclick="navigateSearch(1)" title="Pr√≥ximo">‚ñº</button>
    </div>

    <button id="driveBtn" type="button" title="Biblioteca no Google Drive" aria-label="Biblioteca no Google Drive">üìÅ</button>
    <button onclick="window.print()">PDF</button>
    <span id="fileName"></span>
</header>

<aside id="drivePanel" class="drive-panel hidden" aria-live="polite">
    <h3>Biblioteca Drive</h3>
    <p class="drive-note">Abra o manual com 1 clique e a pasta compartilhada no Drive. A listagem automatica de arquivos `.md` na pasta e opcional e usa API key.</p>
    <div class="drive-actions">
        <button id="loadDefaultDriveFileBtn" type="button">Abrir manual</button>
        <button id="openDriveFolderBtn" type="button">Abrir pasta</button>
        <button id="setDriveApiKeyBtn" type="button">API key</button>
    </div>
    <div id="driveFiles" class="drive-files">
        <span class="drive-empty">Sem listagem automatica. Preencha `DRIVE_CONFIG.apiKey` no HTML para listar os .md da pasta aqui.</span>
    </div>
</aside>

<div class="container">
    <article id="content" class="markdown-body">
        <h1 style="color: #ccc; text-align: center;">Selecione um arquivo .md</h1>
    </article>
</div>

<button id="scrollTopBtn" type="button" title="Voltar ao topo" aria-label="Voltar ao topo">
    <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 6.5a1 1 0 0 1 .7.29l6 6a1 1 0 1 1-1.4 1.42L12 8.9l-5.3 5.3a1 1 0 1 1-1.4-1.42l6-6a1 1 0 0 1 .7-.29z"></path>
    </svg>
</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>

<script>
    const DRIVE_CONFIG = {
        defaultFileId: "1X1HFU2EqR9PYnf9m2-2vdFizA71T2Qse",
        folderId: "1HjJZiyQejorhK12XxyUzS3CwV5f0QPoP",
        folderUrl: "https://drive.google.com/drive/folders/1HjJZiyQejorhK12XxyUzS3CwV5f0QPoP?usp=sharing",
        apiKey: localStorage.getItem('drive_api_key') || "AIzaSyBnPl69k4YYjeYz-A-MOZg5U8lvd_GSSuU" // Opcional: API key do Google para leitura via Drive API.
    };

    let originalHTML = ""; 
    let matches = [];
    let currentIndex = -1;
    let driveFilesLoaded = false;
    const scrollTopBtn = document.getElementById('scrollTopBtn');

    window.addEventListener('scroll', () => {
        scrollTopBtn.style.display = window.scrollY > 220 ? 'flex' : 'none';
    });

    scrollTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('fileName').textContent = file.name;
        const reader = new FileReader();
        reader.onload = function(e) {
            originalHTML = marked.parse(e.target.result);
            document.getElementById('content').innerHTML = originalHTML;
            resetSearch();
            renderExtras();
        };
        reader.readAsText(file);
    });

    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('keydown', (e) => { 
        if (e.key === 'Enter') executeSearch(searchInput.value); 
    });
    document.getElementById('driveBtn').addEventListener('click', toggleDrivePanel);
    document.getElementById('loadDefaultDriveFileBtn').addEventListener('click', () => {
        loadMarkdownFromGoogleDrive(DRIVE_CONFIG.defaultFileId, 'git_manual.md');
    });
    document.getElementById('openDriveFolderBtn').addEventListener('click', () => {
        window.open(DRIVE_CONFIG.folderUrl, '_blank', 'noopener,noreferrer');
    });
    document.getElementById('setDriveApiKeyBtn').addEventListener('click', setDriveApiKey);

    function resetSearch() {
        matches = [];
        currentIndex = -1;
        document.getElementById('searchCount').textContent = "0/0";
    }

    function executeSearch(term) {
        const content = document.getElementById('content');
        term = term.trim();
        content.innerHTML = originalHTML;
        resetSearch();

        if (!term) { renderExtras(); return; }

        const innerSearch = (node) => {
            if (node.nodeType === 3) {
                const text = node.nodeValue;
                const re = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, "gi");
                if (re.test(text)) {
                    const span = document.createElement('span');
                    span.innerHTML = text.replace(re, '<mark class="search-highlight">$1</mark>');
                    node.parentNode.replaceChild(span, node);
                }
            } else if (node.nodeType === 1 && !/(style|script)/i.test(node.tagName)) {
                Array.from(node.childNodes).forEach(innerSearch);
            }
        };

        innerSearch(content);
        renderExtras();

        matches = Array.from(document.querySelectorAll('.search-highlight'));
        if (matches.length > 0) {
            currentIndex = 0;
            updateSearchUI();
        }
    }

    function navigateSearch(direction) {
        if (matches.length === 0) return;

        // Remove destaque do anterior
        if (currentIndex >= 0) matches[currentIndex].classList.remove('current-highlight');

        currentIndex += direction;
        if (currentIndex >= matches.length) currentIndex = 0;
        if (currentIndex < 0) currentIndex = matches.length - 1;

        updateSearchUI();
    }

    function updateSearchUI() {
        const countDisplay = document.getElementById('searchCount');
        countDisplay.textContent = `${currentIndex + 1}/${matches.length}`;
        
        const current = matches[currentIndex];
        current.classList.add('current-highlight');
        current.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function renderExtras() {
        const content = document.getElementById('content');
        content.querySelectorAll('pre').forEach((pre) => {
            if (pre.parentElement.className === 'code-wrapper') return;
            const wrapper = document.createElement('div');
            wrapper.className = 'code-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            const btn = document.createElement('button');
            btn.className = 'copy-btn';
            btn.textContent = 'Copy';
            btn.onclick = () => {
                navigator.clipboard.writeText(pre.innerText).then(() => {
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy', 2000);
                });
            };
            wrapper.appendChild(btn);
        });
        Prism.highlightAll();
    }

    async function toggleDrivePanel() {
        const panel = document.getElementById('drivePanel');
        panel.classList.toggle('hidden');
        if (!panel.classList.contains('hidden') && !driveFilesLoaded) {
            driveFilesLoaded = true;
            await loadDriveFolderFiles();
        }
    }

    async function loadMarkdownFromGoogleDrive(fileId, fileName = 'arquivo-drive.md') {
        const apiKey = (DRIVE_CONFIG.apiKey || '').trim();
        if (apiKey) {
            const apiUrl = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(fileId)}?alt=media&supportsAllDrives=true&key=${encodeURIComponent(apiKey)}`;
            try {
                const response = await fetch(apiUrl);
                if (response.ok) {
                    const text = await response.text();
                    if (text && !/<!doctype html/i.test(text)) {
                        originalHTML = marked.parse(text);
                        document.getElementById('content').innerHTML = originalHTML;
                        document.getElementById('fileName').textContent = fileName;
                        resetSearch();
                        renderExtras();
                        return;
                    }
                } else {
                    let message = `status ${response.status}`;
                    try {
                        const errorJson = await response.json();
                        message = errorJson?.error?.message || message;
                    } catch (_) {}
                    throw new Error(message);
                }
            } catch (error) {
                const detail = error && error.message ? error.message : 'erro desconhecido';
                alert(`Falha ao carregar via Drive API: ${detail}`);
            }
        }

        const urls = [
            `https://drive.google.com/uc?export=download&id=${fileId}`,
            `https://drive.usercontent.google.com/download?id=${fileId}&export=download&confirm=t`
        ];

        for (const url of urls) {
            try {
                const response = await fetch(url);
                if (!response.ok) continue;
                const text = await response.text();
                if (!text || /<!doctype html/i.test(text)) continue;

                originalHTML = marked.parse(text);
                document.getElementById('content').innerHTML = originalHTML;
                document.getElementById('fileName').textContent = fileName;
                resetSearch();
                renderExtras();
                return;
            } catch (_) {}
        }
        alert('Nao foi possivel carregar o arquivo diretamente do Drive. Se continuar falhando, configure uma API key no botao "API key" e confirme que o arquivo esta publico para visualizacao.');
    }

    async function loadDriveFolderFiles() {
        const container = document.getElementById('driveFiles');
        if (!DRIVE_CONFIG.apiKey) return;

        container.innerHTML = '<span class="drive-empty">Carregando arquivos...</span>';
        const query = encodeURIComponent(`'${DRIVE_CONFIG.folderId}' in parents and trashed=false and (name contains '.md' or name contains '.MD')`);
        const url = `https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name,mimeType)&orderBy=name&includeItemsFromAllDrives=true&supportsAllDrives=true&key=${encodeURIComponent(DRIVE_CONFIG.apiKey)}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                let message = `status ${response.status}`;
                try {
                    const errorJson = await response.json();
                    message = errorJson?.error?.message || message;
                } catch (_) {}
                throw new Error(message);
            }
            const data = await response.json();
            const files = Array.isArray(data.files) ? data.files : [];

            if (files.length === 0) {
                container.innerHTML = '<span class="drive-empty">Nenhum arquivo .md encontrado na pasta compartilhada.</span>';
                return;
            }

            container.innerHTML = '';
            files.forEach((file) => {
                const button = document.createElement('button');
                button.className = 'drive-file';
                button.type = 'button';
                button.textContent = file.name;
                button.title = `Abrir ${file.name}`;
                button.onclick = () => loadMarkdownFromGoogleDrive(file.id, file.name);
                container.appendChild(button);
            });
        } catch (error) {
            const detail = (error && error.message) ? error.message : 'erro desconhecido';
            container.innerHTML = `<span class="drive-empty">Falha ao listar arquivos. Verifique Drive API habilitada, restricao de dominio da chave e permissoes publicas da pasta/arquivos. Detalhe: ${detail}</span>`;
        }
    }

    function setDriveApiKey() {
        const current = DRIVE_CONFIG.apiKey || '';
        const value = prompt('Cole sua Google Drive API key (deixe vazio para remover):', current);
        if (value === null) return;
        const key = value.trim();
        DRIVE_CONFIG.apiKey = key;
        if (key) {
            localStorage.setItem('drive_api_key', key);
            loadDriveFolderFiles();
        } else {
            localStorage.removeItem('drive_api_key');
            document.getElementById('driveFiles').innerHTML = '<span class="drive-empty">Sem listagem automatica. Preencha `DRIVE_CONFIG.apiKey` no HTML para listar os .md da pasta aqui.</span>';
        }
    }
</script>
</body>
</html>
